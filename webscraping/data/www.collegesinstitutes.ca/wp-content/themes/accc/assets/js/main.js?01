// passing the jQuery object to prevent conflict with other libraries that are potentially using the $
(function ($) {

    $(function () {

		// Set some bas vars
		var $window		= $(window),
			$document	= $(document),
			$html		= $('html'),
			$body		= $('body');

		// Check for mobile devices (I know... not cool!)
		var isMobile = {
		    Android: function() {
		        return navigator.userAgent.match(/Android/i);
		    },
		    BlackBerry: function() {
		        return navigator.userAgent.match(/BlackBerry/i);
		    },
		    iOS: function() {
		        return navigator.userAgent.match(/iPhone|iPad|iPod/i);
		    },
		    Opera: function() {
		        return navigator.userAgent.match(/Opera Mini/i);
		    },
		    Windows: function() {
		        return navigator.userAgent.match(/IEMobile/i);
		    },
		    Ismobi: function() {
		    	return navigator.userAgent.match(/Mobi/i);
		    },
		    BB10: function() {
		    	return navigator.userAgent.match(/(BB10; Touch)/i);
		    },
		    any: function() {
				return navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobi|(BB10; Touch)/i);
			}
		};

		$("div.the-content a").not('div.the-content .media a').each(function() {
	        var match = this.href.match(/\.([a-zA-Z0-9]{2,4})([#;\?]|$)/);
			if(match) {
				//if( !$(this).has('img') ) {
		        	$(this).addClass("icon-" + match[1]);
				//}
		    }
		});

		// Toggle Menu
		var siteNav = $('.main-nav');
		$("a#toggle-menu").on('click', function(e) {
			e.stopPropagation();
			e.preventDefault();
			siteNav.slideToggle(200);
		});

		// Toggle Search
		var searchForm = $('div.search-form');
		$("a#toggle-search").on('click', function(e) {
			var $this = $(this);
			e.stopPropagation();
			e.preventDefault();
			searchForm.slideToggle(200);
			$this.toggleClass('active');
			//searchForm.find('input[type="text"]').focus();
		});

		// Toggle Page Nav
		var pageNav = $('.page-nav');
		$("a#toggle-sub-menu").on('click', function(e) {
			e.stopPropagation();
			e.preventDefault();
			pageNav.slideToggle(200);
		});

		// Main Navigation Mega Nav
		magaNav = function() {

			var maxHeight 	= -1,
				theHeader	= $('.header'),
				ddContainer = $('div.main-nav-dd-bg div.container'),
				theTarget	= $('nav.main-nav > ul > li'),
				hov 		= '1';

			$('.main-nav > ul ul').each(function() {
				$this = $(this);
				maxHeight = maxHeight > $this.height() ? maxHeight : $this.height();
			});

			ddContainer.css({
				'min-height' : maxHeight + 40 + 'px'
			});

			theTarget.on('mouseenter', function(e) {
				e.stopPropagation();
				$('div.main-nav-dd-bg').stop(true, true).delay(100).slideDown(300);
				$('nav.main-nav ul.sub-menu').stop(true, true).delay(200).fadeIn(400);
			});
			theTarget.on('mouseleave', function(e) {
				$('.main-nav ul.sub-menu').stop(true, true).delay(200).fadeOut(200);
				$('div.main-nav-dd-bg').stop(true, true).delay(200).slideUp(300);
			});
			ddContainer.on('mouseleave', function(e) {
				e.stopPropagation();
				$('.main-nav ul.sub-menu').stop(true, true).delay(200).fadeOut(200);
				$('div.main-nav-dd-bg').stop(true, true).delay(200).slideUp(300);
			});
			ddContainer.on('mouseenter', function(e) {
				$('div.main-nav-dd-bg').stop(true, true).delay(100).slideDown(400);
				$('nav.main-nav ul.sub-menu').stop(true, true).delay(200).fadeIn(400);
			});

		}
		if ($window.width() >= 753) {
			magaNav();
		}

		// Breadcrumb
		if( $('div.breadcrumb').hasClass('fr') ) {
			$('div.breadcrumb > a.home').text('Accueil');
		}

		// Equal Heights Funtion
		equalheight = function(container) {

			var currentTallest = 0,
			    currentRowStart = 0,
			    rowDivs = new Array(),
			    $el,
			    topPosition = 0;

			$(container).each(function() {

				$el = $(this);
				$($el).height('auto')
				topPostion = $el.position().top;

				if (currentRowStart != topPostion) {
					for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
						rowDivs[currentDiv].height(currentTallest);
					}
					rowDivs.length = 0;
					currentRowStart = topPostion;
					currentTallest = $el.height();
					rowDivs.push($el);
					} else {
						rowDivs.push($el);
						currentTallest = (currentTallest < $el.height()) ? ($el.height()) : (currentTallest);
					}

				for (currentDiv = 0; currentDiv < rowDivs.length ; currentDiv++) {
					rowDivs[currentDiv].height(currentTallest);
				}

			});
		}

		var recentContent = $('#recent-content'),
			defs = {};

		var bxsettings1 = {
			mode: 'horizontal',
			infiniteLoop			: false,
			auto					: false,
			pause					: 6000,
			useCSS					: false,
			speed					: 800,
			controls				: false,
			responsive				: true,
			adaptiveHeight			: false,
			//adaptiveHeightSpeed		: 500,
			slideWidth				: 282,
			minSlides				: 4,
			maxSlides				: 4,
			moveSlides				: 4
		};

		var bxsettings2 = {
			mode: 'horizontal',
			infiniteLoop			: false,
			auto					: false,
			pause					: 6000,
			useCSS					: false,
			speed					: 800,
			controls				: false,
			responsive				: true,
			adaptiveHeight			: false,
			//adaptiveHeightSpeed		: 500,
			slideWidth				: 282,
			minSlides				: 2,
			maxSlides				: 2,
			moveSlides				: 2
		};

		if ($window.width() >= 945) {
			defs = bxsettings1;
		} else {
			defs = bxsettings2;
		}
		if ( $window.width() >= 585 ) {
			recentContent.bxSlider(defs);
		}

		// Instagram Slider
		var instaContent = $('div.instag ul.thumbnails'),
			instaDefs = {};

		var instasettings1 = {
			mode: 'horizontal',
			infiniteLoop			: true,
			auto					: false,
			pause					: 6000,
			useCSS					: false,
			speed					: 1000,
			controls				: false,
			responsive				: true,
			adaptiveHeight			: false,
			minSlides				: 6,
			maxSlides				: 6,
			moveSlides				: 6,
			slideWidth				: 215,
			autoHover				: true,
			autoDelay				: 1000
		};
		var instasettings2 = {
			mode: 'horizontal',
			infiniteLoop			: true,
			auto					: false,
			pause					: 6000,
			useCSS					: false,
			speed					: 1000,
			controls				: false,
			responsive				: true,
			adaptiveHeight			: false,
			minSlides				: 4,
			maxSlides				: 4,
			moveSlides				: 4,
			slideWidth				: 315,
		};
		var instasettings3 = {
			mode: 'horizontal',
			infiniteLoop			: true,
			auto					: false,
			pause					: 6000,
			useCSS					: false,
			speed					: 1000,
			controls				: false,
			responsive				: true,
			adaptiveHeight			: false,
			minSlides				: 2,
			maxSlides				: 2,
			moveSlides				: 2,
			slideWidth				: 380,
		};

		if ($window.width() >= 945) {
			instaDefs = instasettings1;
		} else if ( $window.width() >= 585 && $window.width() <= 945 ) {
			instaDefs = instasettings2;
		} else {
			instaDefs = instasettings3;
		}
		instaContent.bxSlider(instaDefs);

		// Custom dropdown
        $('ul.custom-dd-children').hide();
        $('a.custom-dd-parent-link').on("click", function(e) {
          	e.preventDefault();
            $this = $(this);
            $this.toggleClass('active');
            $this.next('ul.custom-dd-children').addClass('showdd');
            if ($this .next('ul.custom-dd-children').hasClass('showdd')) {
                $this .next('ul.custom-dd-children').fadeToggle(50);
            }
        });
        //	Hide dropdowns on mouseleave
        $('ul li.custom-dd-parent').mouseleave(function () {
            $this = $(this);
            $this.find('ul.custom-dd-children').fadeOut(200).removeClass('showdd');
            $('a.custom-dd-parent-link').removeClass('active');
        });

		// Form Checkbox Thing
		var the_form = $('form#acform > input#check1');
	    the_form.on('click', function() {
	    	var $this = $(this);
	        if ($this.is(":checked")) {
	            $("#proceed").removeAttr("disabled");
	        } else {
	            $("#proceed").attr("disabled", "disabled");
	        }
	    });

		$('a[href*="#"]:not([href="#"])').on('click', function(e) {
			if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
				var target = $(this.hash);
				target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
				if (target.length) {
					$('html, body').animate({
						scrollTop: target.offset().top
					}, 800);
					e.preventDefault();
				}
			}
		});

		// Equal heights on 'Project' blocks
        $window.on("load", function() {
	    	equalheight('div.hp-callouts article.grid_4');
	    	equalheight('div.page-callouts article.grid_4');
	    	equalheight('div.page-callouts article.grid_3');
	    });

		$(document).on('facetwp-loaded', function() {
        	equalheight('div.facets div.facet-results div.list-of-results');
     	});

     	$(window).resize(function() {
			equalheight('div.facets div.facet-results div.list-of-results');
		});

		// Global resize function
		$window.smartresize(function() {

			if ($window.width() >= 945) {
				defs = bxsettings1;
			} else {
				defs = bxsettings2;
			}
			if ( ($window.width() >= 585) && recentContent.length) {
				recentContent.reloadSlider(defs);
			}

			if ($window.width() >= 945) {
			instaDefs = instasettings1;
			} else if ( $window.width() >= 585 && $window.width() <= 945 ) {
				instaDefs = instasettings2;
			} else {
				instaDefs = instasettings3;
			}

			if (instaContent.length) {
				instaContent.reloadSlider(instaDefs);
			}

			equalheight('div.hp-callouts article.grid_4');
	    	equalheight('div.page-callouts article.grid_4');
	    	equalheight('div.page-callouts article.grid_3');

		});

	});

    // Infinite scrolling on Facet results
    window.fwp_is_paging = false;

	$(document).on('facetwp-refresh', function() {
		// $('.facetwp-template .facetwp-results').hide();
		// $('.facetwp-template').addClass('facetwp-loading');

        if (!window.fwp_is_paging) {
            window.fwp_page = 1;
            FWP.extras.per_page = 'default';
        }

        window.fwp_is_paging = false;
	});

	$(document).on('facetwp-loaded', function() {
		// $('html, body').animate({ scrollTop: 0 }, 500);
		$('.facetwp-template').removeClass('facetwp-loading');
		$('.facetwp-template .facetwp-results').show();

		// Hide landing content, and show results, if any facets are set
		if (fwpIsSet()) {
			fwpToggleContent();
		}

        window.fwp_total_rows = FWP.settings.pager.total_rows;

        if ($('body').hasClass('page-template-page-resourceslandingpage') && !FWP.loaded) {
            window.fwp_default_per_page = 20;
            $('.facetwp-content').append('<div class="facet-loading"></div>');

            $(window).scroll(function() {
                if ($(window).scrollTop() + $(window).height() == $(document).height()) {
                    var rows_loaded = (window.fwp_page * window.fwp_default_per_page);

                    if (rows_loaded < window.fwp_total_rows) {
                        // console.log(rows_loaded + ' of ' + window.fwp_total_rows + ' rows');
                        window.fwp_page++;
                        window.fwp_is_paging = true;
                        FWP.extras.per_page = (window.fwp_page * window.fwp_default_per_page);
                        FWP.soft_refresh = true;
                        FWP.refresh();
                    } else {
                        $('.facet-loading').slideUp('slow');
                    }
                }
            });
        } else if ($('body').hasClass('page-template-page-listofdegrees')) {
            $('.facetwp-pager').show();
            $(document).on('facetwp-loaded', function() {
                $('html, body').animate({ scrollTop: 0 }, 500);
            });
        }
	});

	$(document).ready(function() {
		$('#facets').click(function() {
			fwpToggleContent();
		});

		$('#facets span.reset').click(function() {
			$('.facetwp-template .facetwp-results').hide();
			$('.facetwp-template').addClass('facetwp-loading');

			var facet = $(this).data("facet");
			if (facet == "reset") {
				fwpToggleContent("landing");
				FWP.reset();
			} else {
				fwpClear(facet);
			}

			return false;
		});
	});

	// Toggle visibility of landing content and results content
	function fwpToggleContent(state) {
		if (state == "landing") {
			// $('.facetwp-content').hide();
			$('.facetwp-landing').show();
		} else {
			// $('.facetwp-landing').hide();
			$('.facetwp-content').show();
		}
	}

	// Check if any facets are currently applied
	function fwpIsSet() {
		var output = false;

		$.each(FWP.facets, function(f) {
			if (!isEmpty(FWP.facets[f])) {
				console.log(FWP.facets[f]);
				output = true;
			}
		});

		return output;
	}

	// Clears a specific facet
	function fwpClear(facet) {
		FWP.parse_facets();
		$.each(FWP.facets, function(f) {
			if (f == facet) {
				FWP.facets[f] = [];
			}
		});
		FWP.set_hash();
		FWP.fetch_data();
	}

	// Check if object is empty
	var hasOwnProperty = Object.prototype.hasOwnProperty;
	function isEmpty(obj) {
		// null and undefined are "empty"
		if (obj == null) return true;

		// Assume if it has a length property with a non-zero value
		// that that property is correct.
		if (obj.length > 0)    return false;
		if (obj.length === 0)  return true;

		// Otherwise, does it have any properties of its own?
		// Note that this doesn't handle
		// toString and valueOf enumeration bugs in IE < 9
		for (var key in obj) {
			if (hasOwnProperty.call(obj, key)) return false;
		}

		return true;
	}

    $(window).scroll(function(e) {
        if ($(window).scrollTop() >= 555) {
            $('.teams-dropdown').addClass('teams-dropdown-fixed');
            $('.staff-members .team').first().css('margin-top', '95px');
        } else {
            $('.teams-dropdown').removeClass('teams-dropdown-fixed');
            $('.staff-members .team').first().css('margin-top', '40px');
        }
    });

    // Initialize jQuery UI accordions
    $('.accordion').accordion({
        heightStyle : "content",
        collapsible : true,
        active : false
    });

    // Lightbox modal for YouTube and Vimeo links
    $('a').each(function() {
        if (this.href.match(/youtube\.com/) || this.href.match(/vimeo\.com/)) {
            if ($(this).parents('.gallery').length == 0) {
                $(this).magnificPopup({
                    type: 'iframe',
                    mainClass: 'mfp-fade',
                    removalDelay: 160,
                    preloader: false,
                    fixedContentPos: true
                });
            }
        }
    });

    var infinitescrolling = {
        loading: {
            img: "//www.collegesinstitutes.ca/wp-content/themes/accc/assets/img/layout/bx_loader.gif",
            msgText: ""
        },

        "nextSelector": ".next, .tribe-events-sub-nav a",
        "navSelector": ".page-numbers, .tribe-events-sub-nav",
        "itemSelector": ".common-listings, .grid-row, .type-tribe_events",
        "contentSelector": ".the-content, #tribe-events-content .tribe-events-loop"
    };

    $(infinitescrolling.contentSelector).infinitescroll(infinitescrolling);

    $('.gform_wrapper #add').click(function(e) {
        e.preventDefault();
        $(this).parents('ul').find('.hidden').slice(0, 2).fadeIn(1500).removeClass('hidden');

        if ($(this).parents('ul').find('.hidden').length == 0) {
            $(this).fadeOut(800);
        }
    });
})(jQuery);